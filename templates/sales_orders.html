{% extends 'base.html' %}

{% block content %}

<h2>Sales Orders</h2>

<!-- ================= SALES ORDER LIST ================= -->
{% if orders %}
<table>
    <thead>
        <tr>
            <th>SO No</th>
            <th>Customer</th>
            <th>Customer PO No</th>
            <th>Date</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
    {% for so in orders %}
        <tr>
            <td>{{ so.so_number }}</td>
            <td>{{ so.customer.customer_name }}</td>
            <td>{{ so.customer_po_number }}</td>
            <td>{{ so.order_date.strftime('%d-%m-%Y') }}</td>
            <td>{{ so.status }}</td>
        </tr>

        <!-- SO ITEMS -->
        <tr>
            <td colspan="5">
                <table width="100%" style="margin:10px 0;">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Ordered Qty</th>
                            <th>Invoiced Qty</th>
                            <th>Remaining Qty</th>
                            <th>Unit Price</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in so.items %}
                        <tr>
                            <td>{{ item.product_name }}</td>
                            <td>{{ item.ordered_qty }}</td>
                            <td>{{ item.invoiced_qty }}</td>
                            <td>
                                {{ item.ordered_qty - item.invoiced_qty }}
                            </td>
                            <td>₹{{ item.unit_price }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>No sales orders yet.</p>
{% endif %}

<hr>

<!-- ================= ADD SALES ORDER ================= -->
<h2>Add Sales Order</h2>

<form method="POST" action="{{ url_for('add_sales_order') }}">

    <div class="form-section">
        <label>Customer</label><br>
        <select name="customer_id" required>
            <option value="">-- Select Customer --</option>
            {% for c in customers %}
            <option value="{{ c.id }}">{{ c.customer_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-section">
        <label>Customer PO Number</label><br>
        <input type="text" name="customer_po_number" required>
    </div>

    <div class="form-section">
        <h3>Products</h3>

        <div id="so_items"></div>

        <select id="product_select">
            <option value="">-- Select Product --</option>
            {% for p in products %}
            <option value="{{ p.id }}"
                    data-name="{{ p.name }}"
                    data-price="{{ p.price }}">
                {{ p.name }}
            </option>
            {% endfor %}
        </select>

        <input type="number" id="product_qty" min="1" placeholder="Qty">
        <input type="number" id="product_price" step="0.01" placeholder="Price">

        <button type="button" onclick="addSOItem()">Add Product</button>
    </div>

    <br>
    <button type="submit">Create Sales Order</button>

</form>

<!-- ================= JS ================= -->
<script>
function addSOItem() {
    const sel = document.getElementById("product_select");
    const opt = sel.selectedOptions[0];

    if (!opt.value) return;

    const qty = document.getElementById("product_qty").value;
    const price = document.getElementById("product_price").value || opt.dataset.price;

    if (!qty || qty <= 0) return;

    document.getElementById("so_items").insertAdjacentHTML(
        "beforeend",
        `
        <div class="so-row">
            <input type="hidden" name="product_id[]" value="${opt.value}">
            <input type="hidden" name="quantity[]" value="${qty}">
            <input type="hidden" name="price[]" value="${price}">

            <span>${opt.dataset.name}</span>
            <span>Qty: ${qty}</span>
            <span>₹${price}</span>

            <button type="button" onclick="this.parentElement.remove()">Remove</button>
        </div>
        `
    );

    sel.selectedIndex = 0;
    document.getElementById("product_qty").value = "";
    document.getElementById("product_price").value = "";
}
</script>

<style>
.form-section {
    margin-bottom: 15px;
}

.so-row {
    display: flex;
    gap: 15px;
    padding: 8px;
    background: #f5f5f5;
    margin-bottom: 6px;
    border-radius: 4px;
}
</style>

{% endblock %}

{% extends 'base.html' %}
{% block content %}

<h2>Sales Orders</h2>
<label for="statusFilter"><b>Filter by Status:</b></label>
<select id="statusFilter" onchange="filterStatus()">
    <option value="all">All</option>
    <option value="open">Fresh</option>
    <option value="partially-invoiced">Partially Invoiced</option>
    <option value="completed">Fulfilled</option>
</select>

<br><br>
{% if orders %}
<table class="so-table">
    <thead>
        <tr>
            <th>SO No</th>
            <th>Customer</th>
            <th>PO No</th>
            <th>Date</th>
            <th>Status</th>
            <th>Product</th>
            <th>Ordered</th>
            <th>Invoiced</th>
            <th>Remaining</th>
            <th>Unit Price</th>
        </tr>
    </thead>
    <tbody>
    {% for so in orders %}
        {% for item in so.items %}
        <tr>
            <td>{{ so.so_number }}</td>
            <td>{{ so.customer.customer_name }}</td>
            <td>{{ so.customer_po_number }}</td>
            <td>{{ so.order_date.strftime('%d-%m-%Y') }}</td>
            <td class="status {{ so.status|lower|replace(' ', '-') }}">{{ so.status }}</td>
            <td>{{ item.product_name }}</td>
            <td>{{ item.ordered_qty }}</td>
            <td>{{ item.invoiced_qty }}</td>
            <td>{{ item.ordered_qty - item.invoiced_qty }}</td>
            <td>₹{{ "%.2f"|format(item.unit_price) }}</td>
        </tr>
        {% endfor %}
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>No sales orders yet.</p>
{% endif %}

<hr>

<h2>Add Sales Order</h2>

<form method="POST" action="{{ url_for('add_sales_order') }}">

    <div class="form-section">
        <label>Customer</label><br>
        <select name="customer_id" required>
            <option value="">-- Select Customer --</option>
            {% for c in customers %}
            <option value="{{ c.id }}">{{ c.customer_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-section">
        <label>Customer PO Number</label><br>
        <input type="text" name="customer_po_number" required>
    </div>

    <div class="form-section">
        <h3>Products</h3>

        <div id="so_items"></div>

        <select id="product_select">
            <option value="">-- Select Product --</option>
            {% for p in products %}
            <option value="{{ p.id }}" data-name="{{ p.name }}" data-price="{{ p.price }}">
                {{ p.name }}
            </option>
            {% endfor %}
        </select>

        <input type="number" id="product_qty" min="1" placeholder="Qty">
        <input type="number" id="product_price" step="0.01" placeholder="Price">

        <button type="button" onclick="addSOItem()">Add Product</button>
    </div>

    <br>
    <button type="submit">Create Sales Order</button>

</form>

<script>
function addSOItem() {
    const sel = document.getElementById("product_select");
    const opt = sel.selectedOptions[0];
    if (!opt.value) return;

    const qty = document.getElementById("product_qty").value;
    const price = document.getElementById("product_price").value || opt.dataset.price;
    if (!qty || qty <= 0) return;

    document.getElementById("so_items").insertAdjacentHTML("beforeend", `
        <div class="so-row">
            <input type="hidden" name="product_id[]" value="${opt.value}">
            <input type="hidden" name="quantity[]" value="${qty}">
            <input type="hidden" name="price[]" value="${price}">
            <span>${opt.dataset.name}</span>
            <span>Qty: ${qty}</span>
            <span>₹${price}</span>
            <button type="button" onclick="this.parentElement.remove()">Remove</button>
        </div>
    `);

    sel.selectedIndex = 0;
    document.getElementById("product_qty").value = "";
    document.getElementById("product_price").value = "";
}

function filterStatus() {
    const filter = document.getElementById("statusFilter").value;
    const rows = document.querySelectorAll(".so-table tbody tr");

    rows.forEach(row => {
        const statusCell = row.querySelector(".status");
        if (!statusCell) return;

        const statusClass = statusCell.classList[1]; // open / completed / partially-invoiced

        if (filter === "all" || statusClass === filter) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
}
</script>


<style>
.so-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.so-table th, .so-table td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
}

.status.open { color: orange; }
.status.completed { color: green; }
.status.partially-invoiced { color: blue; }

.form-section {
    margin-bottom: 15px;
}

.so-row {
    display: flex;
    gap: 15px;
    padding: 8px;
    background: #f5f5f5;
    margin-bottom: 6px;
    border-radius: 4px;
}
</style>

{% endblock %}
